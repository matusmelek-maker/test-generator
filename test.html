<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Test ‚Äì Gener√°tor</title>
  <!-- ‚úÖ Opraven√° cesta k CSS -->
  <link rel="stylesheet" href="style.css" />
  <style>
    #progressBox {
      text-align: right;
      font-weight: bold;
      font-size: 16px;
      color: #0d47a1;
      margin-bottom: 10px;
    }

    #finishText {
      text-align: center;
      font-size: 22px;
      font-weight: 700;
      color: #1565C0;
      margin: 25px 0 10px 0;
      animation: fadeIn 0.8s ease-in-out;
    }
  </style>
</head>
<body>

<header>
  <h1>üß† Test ‚Äì Gener√°tor ot√°zok</h1>
</header>

<main>
  <div id="testContainer" class="form">
    <div id="progressBox"></div>
    <h2 id="nazovTestu"></h2>
    <div id="otazkaText"></div>
    <div id="odpovede"></div>
    <div class="button-group" id="buttons">
      <button id="skontroluj">Skontroluj ot√°zku</button>
      <button id="dalsiaOtazka">‚û°Ô∏è ƒéal≈°ia ot√°zka</button>
      <button onclick="nastavInterval('medium')">üü° Stredn√° (5 min)</button>
      <button onclick="nastavInterval('hard')">üî¥ ≈§a≈æk√° (3 min)</button>
    </div>
    <div id="scoreBox" style="display:none;"></div>
    <div id="vysledky"></div>
  </div>
</main>

<script>
  const otazky = JSON.parse(localStorage.getItem("otazky") || "[]");
  const odpovede = JSON.parse(localStorage.getItem("odpovede") || "[]");
  const jeBio = localStorage.getItem("jeBio") === "true";
  const mix = JSON.parse(localStorage.getItem("mix") || "false");

  otazky.forEach(o => {
    o.nextTime = Date.now();   // hneƒè dostupn√°
    o.opakovania = 0;          // koƒækokr√°t bola opakovan√°
    o.uzSpravna = false;       // e≈°te nebola spr√°vna
  });

  otazky.forEach(q => {
    q.odpovede = q.odpovede.map((text, aktualnaOtazka) => ({
      text,
      povodnePismeno: String.fromCharCode(65 + aktualnaOtazka)
    }));
    if (mix) q.odpovede.sort(() => Math.random() - 0.5);
  });

  const nazov = document.getElementById("nazovTestu");
  const otazkaText = document.getElementById("otazkaText");
  const odpovedeDiv = document.getElementById("odpovede");
  const btnSkontroluj = document.getElementById("skontroluj");
  const buttons = document.getElementById("buttons");
  const scoreBox = document.getElementById("scoreBox");
  const vysledkyDiv = document.getElementById("vysledky");
  const progressBox = document.getElementById("progressBox");

  let hlavnyIndex = 0;        // ide len dopredu (1 ‚Üí 10)
  let aktualnaOtazka = null; // objekt ot√°zky
  let skontrolovane = false;
  let body = 0;
  const vybraneOdpovede = {};

  nazov.textContent = jeBio ? "Biol√≥gia" : "Ch√©mia";

  function zobrazOtazku() {
    // z√≠ska sa ƒèal≈°ia ot√°zka ako objekt
    aktualnaOtazka = vyberDalsiuOtazku();

    // ak u≈æ ≈æiadna ot√°zka nie je, konƒç√≠me test
    if (!aktualnaOtazka) {
      ukonciTest();
      return;
    }

    skontrolovane = false;
    btnSkontroluj.disabled = false;

    // objekt ot√°zky priamo pou≈æijeme
    const o = aktualnaOtazka;

    // zobraz√≠me text ot√°zky
    otazkaText.innerHTML = o.cislo + ". " + chemFormat(o.text);

    // zobraz√≠me priebeh testu
    progressBox.textContent = `Ot√°zka ${hlavnyIndex} z ${otazky.length}`;

    // vyma≈æeme star√© odpovede
    odpovedeDiv.innerHTML = "";

    // zobraz√≠me odpovede
    o.odpovede.forEach((odp, i) => {
      const pism = String.fromCharCode(65 + i);
      const div = document.createElement("div");
      div.className = "odpoved";

      const label = document.createElement("label");
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.name = "odp";
      checkbox.value = odp.povodnePismeno;

      div.addEventListener("click", () => {
        checkbox.checked = !checkbox.checked;
      });

      label.appendChild(checkbox);
      label.innerHTML += `${pism}. ${chemFormat(odp.text)}`;

      div.appendChild(label);
      odpovedeDiv.appendChild(div);
    });

    btnSkontroluj.disabled = false;
  }
  const btnDalsiaOtazka = document.getElementById("dalsiaOtazka");

  btnDalsiaOtazka.addEventListener("click", () => {
    if (!aktualnaOtazka) return;

    const spravne = odpovede
      .filter(x => x.cislo === aktualnaOtazka.cislo)
      .flatMap(x => x.odpoved);

    const oznacene = Array.from(
      document.querySelectorAll('input[name="odp"]:checked')
    ).map(el => el.value);

    // ak e≈°te nebolo skontrolovan√©, skontrolujeme a pripoƒç√≠tame body
    if (!skontrolovane) {
      const vseSpravne = spravne.every(s => oznacene.includes(s));
      const ziadneZle = oznacene.every(o => spravne.includes(o));
      if (vseSpravne && ziadneZle) {
        body++;
        aktualnaOtazka.uzSpravna = true;
        aktualnaOtazka.nextTime = Infinity;
      }
    }

    // prejdeme na ƒèal≈°iu ot√°zku bez ƒèal≈°ieho bodovania
    zobrazOtazku();
  });

  function skontroluj(auto = false) {
    if (!aktualnaOtazka) return;

    const currentOt = aktualnaOtazka;
    const cisloOtazky = currentOt.cislo;

    const spravne = odpovede
      .filter(x => x.cislo === cisloOtazky)
      .flatMap(x => x.odpoved);

    const oznacene = Array.from(document.querySelectorAll('input[name="odp"]:checked'))
      .map(el => el.value);

    vybraneOdpovede[cisloOtazky] = oznacene;

    const moznosti = document.querySelectorAll(".odpoved");
    moznosti.forEach(div => {
      const checkbox = div.querySelector('input[name="odp"]');
      const pism = checkbox.value;

      div.classList.remove("correct", "partial-correct", "incorrect", "partial-incorrect");

      if (spravne.includes(pism) && oznacene.includes(pism)) div.classList.add("correct");
      else if (spravne.includes(pism) && !oznacene.includes(pism)) div.classList.add("partial-correct");
      else if (!spravne.includes(pism) && oznacene.includes(pism)) div.classList.add("incorrect");
      else div.classList.add("partial-incorrect");
    });

    const vseSpravne = spravne.every(s => oznacene.includes(s));
    const ziadneZle = oznacene.every(o => spravne.includes(o));
    if (vseSpravne && ziadneZle && !auto) body++;

    if (!auto) {
      document.querySelectorAll('input[name="odp"]').forEach(i => i.disabled = true);
      btnSkontroluj.disabled = true;
      skontrolovane = true; // ‚ùó zaznamen√°me, ≈æe sme skontrolovali
    }
  }



  function vyberDalsiuOtazku() {
    const teraz = Date.now();

    // 1Ô∏è‚É£ najprv hƒæad√°me opakovan√∫ ot√°zku, ktorej vypr≈°al ƒças
    const readyOpakovanie = otazky.find(
      o => !o.uzSpravna && o.nextTime <= teraz && o.opakovania > 0
    );

    if (readyOpakovanie) return readyOpakovanie;

    // 2Ô∏è‚É£ inak berieme ƒèal≈°iu nov√∫ ot√°zku v p√¥vodnom porad√≠
    while (hlavnyIndex < otazky.length) {
      const o = otazky[hlavnyIndex++];
      if (!o.uzSpravna && o.opakovania === 0) {
        return o;
      }
    }

    // 3Ô∏è‚É£ niƒç nie je dostupn√©
    return null;
  }

  function dalsia() {
    if (!btnSkontroluj.disabled) skontroluj(true);
    zobrazOtazku();
  }

  function chemFormat(text) {
    return text
      // doln√© indexy (H_2, SO_4)
      .replace(/_(\d+)/g, "<sub>$1</sub>")
      // horn√© indexy s n√°bojom (2-, 3+, +, -)
      .replace(/\^(\d*[+-])/g, "<sup>$1</sup>")
      // obyƒçajn√© horn√© indexy (^2)
      .replace(/\^(\d+)/g, "<sup>$1</sup>");
  }

  function nastavInterval(obtiaznost) {
    if (!aktualnaOtazka) return;

    const spravne = odpovede
      .filter(x => x.cislo === aktualnaOtazka.cislo)
      .flatMap(x => x.odpoved);

    const oznacene = Array.from(
      document.querySelectorAll('input[name="odp"]:checked')
    ).map(el => el.value);

    const ok =
      spravne.every(s => oznacene.includes(s)) &&
      oznacene.every(o => spravne.includes(o));

    aktualnaOtazka.opakovania++;

    // ‚ùó bodovanie len ak e≈°te nebolo stlaƒçen√© Skontroluj
    if (ok && !skontrolovane) {
      body++;
      aktualnaOtazka.uzSpravna = true;
      aktualnaOtazka.nextTime = Infinity;
    } else if (!ok) {
      let delay = 0;
      if (obtiaznost === "medium") delay = 5 * 60 * 1000;
      if (obtiaznost === "hard") delay = 3 * 60 * 1000;

      aktualnaOtazka.nextTime = Date.now() + delay;
    }

    // ‚ùó po nastaven√≠ intervalu prejdeme na ƒèal≈°iu ot√°zku
    zobrazOtazku();
  }

  function ukonciTest() {
    // ‚úÖ odstr√°ni posledn√∫ ot√°zku
    otazkaText.textContent = "";
    odpovedeDiv.innerHTML = "";
    progressBox.textContent = "";
    buttons.style.display = "none";
    nazov.style.display = "none";

    // ‚úÖ text do stredu
    const finishText = document.createElement("div");
    finishText.id = "finishText";
    finishText.textContent = `üéâ Test z ${jeBio ? "Biol√≥gie" : "Ch√©mie"} je dokonƒçen√Ω!`;
    document.getElementById("testContainer").prepend(finishText);

    const percento = Math.round((body / otazky.length) * 100);
    const sprava = percento >= 70
      ? "üéâ Skvel√° pr√°ca!"
      : "üëç E≈°te trochu potr√©nuj.";

    vysledkyDiv.innerHTML = `
      <div class="final-box">
        <h2>${sprava}</h2>
        <p>Z√≠skal si <strong>${body}</strong> z ${otazky.length} ot√°zok (${percento}%).</p>
      </div>
      <div id="scrollPanel" class="scroll-panel"></div>
    `;

    const scrollPanel = document.getElementById("scrollPanel");

    otazky.forEach(o => {
      const otDiv = document.createElement("div");
      otDiv.className = "vysledokOtazka";
      otDiv.innerHTML = `<h3>${o.cislo}. ${o.text}</h3>`;

      const spravne = odpovede.filter(x => x.cislo === o.cislo).flatMap(x => x.odpoved);
      const oznacene = vybraneOdpovede[o.cislo] || [];

      o.odpovede.forEach((odp, j) => {
        const pism = odp.povodnePismeno;
        const div = document.createElement("div");
        div.className = "vysledokOdpoved";
        div.innerHTML = `${pism}. ${chemFormat(odp.text)}`;

        if (spravne.includes(pism) && oznacene.includes(pism)) div.classList.add("correct");
        else if (spravne.includes(pism) && !oznacene.includes(pism)) div.classList.add("partial-correct");
        else if (!spravne.includes(pism) && oznacene.includes(pism)) div.classList.add("incorrect");
        else div.classList.add("partial-incorrect");

        otDiv.appendChild(div);
      });

      scrollPanel.appendChild(otDiv);
    });

    // ‚úÖ nov√© tlaƒçidl√° s jednotn√Ωm ≈°t√Ωlom
    const btnRestart = document.createElement("button");
    btnRestart.textContent = "üîÅ Opakuj test";
    btnRestart.className = "button-restart";
    btnRestart.addEventListener("click", () => window.location.reload());

    const btnDomov = document.createElement("button");
    btnDomov.textContent = "üè† Sp√§≈• na √∫vod";
    btnDomov.className = "button-domov";
    btnDomov.addEventListener("click", () => window.location.href = "index.html");


    vysledkyDiv.appendChild(btnRestart);
    vysledkyDiv.appendChild(btnDomov);
  }

  btnSkontroluj.addEventListener("click", () => skontroluj(false));

  zobrazOtazku();
</script>
</body>
</html>
