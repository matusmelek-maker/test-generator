<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Gener√°tor</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <h1>üìò Test Gener√°tor</h1>
</header>

<main>
  <div class="form">
    <div class="row">
      <label for="predmet">Predmet:</label>
      <select id="predmet">
        <option value="chemia">Ch√©mia</option>
        <option value="biologia">Biol√≥gia</option>
      </select>
    </div>

    <div class="row">
      <label for="typTestu">Typ testu:</label>
      <select id="typTestu">
        <option value="rozsah">Rozsah</option>
        <option value="generator">Gener√°tor</option>
      </select>
    </div>

    <div class="row" id="vstupy"></div>

    <button id="spustiTest">Spusti≈• test</button>

    <div id="legenda">
      <h2>LEGENDA</h2>
      <p><strong>Ch√©mia:</strong> ot√°zky ƒç. 1 ‚Äì 1200</p>
      <p><strong>Zak√°zan√© ot√°zky:</strong><br>
        366, 411, 433, 456, 457, 463, 505, 513, 524, 548, 549, 595, 596, 597, 646, 656, 657, 658, 669, 670, 675, 676, 678,
        679, 680, 747, 749, 910, 948
      </p>
      <p><strong>Biol√≥gia:</strong> ot√°zky ƒç. 1 ‚Äì 1100</p>
    </div>
  </div>
</main>

<script>
  const typTestu = document.getElementById("typTestu");
  const predmet = document.getElementById("predmet");
  const vstupy = document.getElementById("vstupy");
  const spustiButton = document.getElementById("spustiTest");

  function aktualizujVstup() {
    vstupy.innerHTML = "";
    if (typTestu.value === "rozsah") {
      vstupy.innerHTML = `
        <label>Od:</label>
        <input type="number" id="od" min="1" max="1200" placeholder="od">
        <label>Do:</label>
        <input type="number" id="do" min="1" max="1200" placeholder="do">
      `;
    } else {
      vstupy.innerHTML = `
        <label>Poƒçet:</label>
        <input type="number" id="pocet" min="1" max="100" placeholder="poƒçet ot√°zok">
      `;
    }
  }

  typTestu.addEventListener("change", aktualizujVstup);
  window.onload = aktualizujVstup;

  spustiButton.addEventListener("click", async () => {
    const jeBio = predmet.value === "biologia";
    const typ = typTestu.value;
    const od = Number(document.getElementById("od")?.value) || 1;
    const do_ = Number(document.getElementById("do")?.value) || 10;
    const pocet = Number(document.getElementById("pocet")?.value) || 10;

    try {
      // fetch otazky
      const otazkyResponse = await fetch(`data/otazky${jeBio ? "bio" : "chem"}.txt`);
      if (!otazkyResponse.ok) throw new Error("S√∫bor ot√°zok sa nena≈°iel!");
      const otazkyText = await otazkyResponse.text();
      if (!otazkyText.trim()) throw new Error("S√∫bor ot√°zok je pr√°zdny!");

      // fetch odpovede
      const odpovedeResponse = await fetch(`data/odpovede${jeBio ? "bio" : "chem"}.txt`);
      if (!odpovedeResponse.ok) throw new Error("S√∫bor odpoved√≠ sa nena≈°iel!");
      const odpovedeText = await odpovedeResponse.text();
      if (!odpovedeText.trim()) throw new Error("S√∫bor odpoved√≠ je pr√°zdny!");

      const otazky = parseOtazky(otazkyText);
      const odpovede = parseOdpovede(odpovedeText);

      let vybrate = [];
      if (typ === "rozsah") {
        vybrate = otazky.filter(o => o.cislo >= od && o.cislo <= do_);
      } else {
        vybrate = shuffle(otazky).slice(0, pocet);
      }

      localStorage.setItem("otazky", JSON.stringify(vybrate));
      localStorage.setItem("odpovede", JSON.stringify(odpovede));
      localStorage.setItem("jeBio", jeBio);
      window.location.href = "test.html";

    } catch (e) {
      alert("Chyba pri naƒç√≠tan√≠ s√∫borov: " + e.message);
      console.error(e);
    }
  });


  function parseOtazky(text) {
    const lines = text.split("\n");
    const otazky = [];
    let akt = null;
    let odpovede = [];
    for (let line of lines) {
      line = line.trim();
      if (!line) continue;
      if (/^\d+\./.test(line)) {
        if (akt) {
          akt.odpovede = [...odpovede];
          otazky.push(akt);
        }
        const cislo = parseInt(line.split(".")[0]);
        const textOt = line.replace(/^\d+\.\s*/, "");
        akt = { cislo, text: textOt, odpovede: [] };
        odpovede = [];
      } else if (/^[A-D]\./.test(line)) {
        odpovede.push(line.substring(3).trim());
      } else {
        if (akt) akt.text += " " + line;
      }
    }
    if (akt) {
      akt.odpovede = odpovede;
      otazky.push(akt);
    }
    return otazky;
  }

  function parseOdpovede(text) {
    return text.split("\n").map(l => {
      const [cislo, odp] = l.trim().split(/\s+/, 2);
      return { cislo: parseInt(cislo), odpoved: odp.split("") }; // -> pole p√≠smen
    }).filter(o => !isNaN(o.cislo));
  }

  function shuffle(arr) {
    return arr.sort(() => Math.random() - 0.5);
  }
</script>
</body>
</html>
